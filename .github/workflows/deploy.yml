name: Deploy SuperCX Frontend

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy SuperCX Frontend to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 168.231.112.124
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -e
            echo "ðŸš€ Starting Deployment: SuperCX Frontend"

            APP_DIR="/var/www/supercx_frontend"
            if [ ! -d "$APP_DIR" ]; then
              echo "ðŸ“Œ Folder missing â€” cloning..."
              git clone https://github.com/CodeCafeLab/supercx_frontend.git "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "ðŸ“¥ Fetching latest code"
            git fetch origin main --tags
            git reset --hard origin/main
            git clean -fd

            echo "ðŸ“¦ Installing dependencies"
            npm install --legacy-peer-deps

            echo "ðŸŒ Setting environment variable"
            export VITE_API_URL="https://Bankaichat.codecafelab.in"

            echo "ðŸ—ï¸ Building frontend"
            npm run build

            echo "ðŸ” Restarting PM2 app"
            if pm2 describe supercx-frontend >/dev/null 2>&1; then
              pm2 restart supercx-frontend
            else
              pm2 serve dist 3006 --name supercx-frontend --spa
            fi

            pm2 save
            echo "ðŸŽ¯ SuperCX Frontend Deployed Successfully!"
